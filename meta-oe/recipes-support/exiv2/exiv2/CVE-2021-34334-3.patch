From 95f5403e8b3a5d71241b6b9ef809f4097ad404a5 Mon Sep 17 00:00:00 2001
From: Kevin Backhouse <kevinbackhouse@github.com>
Date: Wed, 7 Jul 2021 16:49:24 +0100
Subject: [PATCH] Better fix for potential integer overflow in `bytes.size() -
 3`.

CVE: CVE-2021-34334
Upstream-Status: Backport [https://github.com/Exiv2/exiv2/pull/1766/commits/ee8af718983469af5a86f041b58a5f52b1cbad76]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/iptc.cpp | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/iptc.cpp b/src/iptc.cpp
index f823f74..8e54b9c 100644
--- a/src/iptc.cpp
+++ b/src/iptc.cpp
@@ -351,12 +351,15 @@ namespace Exiv2 {
 
     void IptcData::printStructure(std::ostream& out, const Slice<byte*>& bytes, uint32_t depth)
     {
+        if (bytes.size() < 3) {
+            return;
+        }
         size_t i = 0;
-        while (i + 3 < bytes.size() && bytes.at(i) != 0x1c)
+        while (i < bytes.size() - 3 && bytes.at(i) != 0x1c)
             i++;
         depth++;
         out << Internal::indent(depth) << "Record | DataSet | Name                     | Length | Data" << std::endl;
-        while (i + 3 < bytes.size()) {
+        while (i < bytes.size() - 3) {
             if (bytes.at(i) != 0x1c) {
                 break;
             }
