From bde41fcab99f5def735bc4b0b8515f211eda98c0 Mon Sep 17 00:00:00 2001
From: Kevin Backhouse <kevinbackhouse@github.com>
Date: Tue, 29 Jun 2021 23:32:59 +0100
Subject: [PATCH] Prevent divide-by-zero crash.

CVE: CVE-2021-34335
Upstream-Status: Backport [https://github.com/Exiv2/exiv2/pull/1750/commits/f2d6d24ed74b2c5dbbbdc25bafd42ce9357978f8]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/minoltamn_int.cpp | 16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

diff --git a/src/minoltamn_int.cpp b/src/minoltamn_int.cpp
index f5c0b41..77521fc 100644
--- a/src/minoltamn_int.cpp
+++ b/src/minoltamn_int.cpp
@@ -2179,16 +2179,20 @@ namespace Exiv2 {
 
             if ( model == "ILCE-6000" && maxAperture == F1_8 ) try {
                 long    focalLength = getKeyLong  ("Exif.Photo.FocalLength"      ,metadata);
-                long    focalL35mm  = getKeyLong  ("Exif.Photo.FocalLengthIn35mmFilm",metadata);
-                long    focalRatio  = (focalL35mm*100)/focalLength;
-                if ( inRange(focalRatio,145,155) ) index = 2 ;
+                if (focalLength > 0) {
+                  long    focalL35mm  = getKeyLong  ("Exif.Photo.FocalLengthIn35mmFilm",metadata);
+                  long    focalRatio  = (focalL35mm*100)/focalLength;
+                  if ( inRange(focalRatio,145,155) ) index = 2 ;
+                }
             } catch (...) {}
 
             if ( model == "ILCE-6000" && maxApertures.find(maxAperture) != maxApertures.end() ) try {
                 long    focalLength = getKeyLong  ("Exif.Photo.FocalLength"      ,metadata);
-                long    focalL35mm  = getKeyLong  ("Exif.Photo.FocalLengthIn35mmFilm",metadata);
-                long    focalRatio  = (focalL35mm*100)/focalLength;
-                if ( inRange(focalRatio,145,155) ) index = 3 ;
+                if (focalLength > 0) {
+                  long    focalL35mm  = getKeyLong  ("Exif.Photo.FocalLengthIn35mmFilm",metadata);
+                  long    focalRatio  = (focalL35mm*100)/focalLength;
+                  if ( inRange(focalRatio,145,155) ) index = 3 ;
+                }
             } catch (...) {}
 
             if ( index > 0 ) {
