From 62f97a69edb936544604e669de25e4bf2a9e2f06 Mon Sep 17 00:00:00 2001
From: Divyanshu Rathore <Divyanshu.Rathore@bmwtechworks.in>
Date: Wed, 12 Nov 2025 11:52:00 +0530
Subject: [PATCH 13/18] ImageMagick: Fix CVE-2025-55298

CVE: CVE-2025-55298

This CVE fixed in two parts, this commit includes the first fix.

Upstream-Status: Backport [https://github.com/ImageMagick/ImageMagick/commit/1f93323df9d8c011c31bc4c6880390071f7fb895]

Comment: Refreshed hunk to match latest kirkstone

Signed-off-by: Divyanshu Rathore <Divyanshu.Rathore@bmwtechworks.in>
---
 MagickCore/image.c | 32 ++++++++++++++++++++++++++++++++
 1 file changed, 32 insertions(+)

diff --git a/MagickCore/image.c b/MagickCore/image.c
index 1acf8edbd..7a52236d8 100644
--- a/MagickCore/image.c
+++ b/MagickCore/image.c
@@ -1633,6 +1633,31 @@ MagickExport VirtualPixelMethod GetImageVirtualPixelMethod(const Image *image)
 %    o exception: return any errors or warnings in this structure.
 %
 */
+
+static inline MagickBooleanType PercentNInvalidOperation(char *filename)
+{
+  MagickBooleanType
+    match = MagickFalse;
+
+  size_t
+    length = strlen(filename);
+
+  ssize_t
+    i;
+
+  for (i=0; i < (ssize_t) length-1; i++)
+  {
+    if ((filename[i] == '%') &&
+        ((filename[i+1] == 'n') || (filename[i+1] == 'N')))
+      {
+        filename[i]='?';
+        filename[i+1]='\?';
+        match=MagickTrue;
+      }
+  }
+  return(match);
+}
+
 MagickExport size_t InterpretImageFilename(const ImageInfo *image_info,
   Image *image,const char *format,int value,char *filename,
   ExceptionInfo *exception)
@@ -1652,6 +1677,13 @@ MagickExport size_t InterpretImageFilename(const ImageInfo *image_info,
   (void) CopyMagickString(filename,format,MagickPathExtent);
   if (IsStringTrue(GetImageOption(image_info,"filename:literal")) != MagickFalse)
     return(strlen(filename));
+  if (PercentNInvalidOperation(filename) != MagickFalse)
+    {
+      errno=EPERM;
+      (void) ThrowMagickException(exception,GetMagickModule(),OptionError,
+        "InvalidArgument","`%s'",filename);
+      return(0);
+    }
   while ((cursor=strchr(cursor,'%')) != (const char *) NULL)
   {
     const char
-- 
2.34.1

