From 3d1a6ecbeff10e05d0609125b6feec9ecace7b85 Mon Sep 17 00:00:00 2001
From: Divyanshu Rathore <Divyanshu.Rathore@bmwtechworks.in>
Date: Fri, 24 Oct 2025 12:37:14 +0530
Subject: [PATCH 08/18] ImageMagick: Fix CVE-2025-57807

CVE: CVE-2025-57807

Upstream-Status: Backport [https://github.com/ImageMagick/ImageMagick/commit/077a417a19a5ea8c85559b602754a5b928eef23e]

Comment: Refreshed hunk to match latest kirkstone

Signed-off-by: Divyanshu Rathore <Divyanshu.Rathore@bmwtechworks.in>
---
 MagickCore/blob.c | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/MagickCore/blob.c b/MagickCore/blob.c
index 6a15d4808..38af749fe 100644
--- a/MagickCore/blob.c
+++ b/MagickCore/blob.c
@@ -1598,7 +1598,7 @@ static inline ssize_t WriteBlobStream(Image *image,const size_t length,
   extent=(MagickSizeType) (blob_info->offset+(MagickOffsetType) length);
   if (extent >= blob_info->extent)
     {
-      extent=blob_info->extent+blob_info->quantum+length;
+      extent+=blob_info->quantum+length;
       blob_info->quantum<<=1;
       if (SetBlobExtent(image,extent) == MagickFalse)
         return(0);
@@ -5774,12 +5774,15 @@ MagickExport ssize_t WriteBlob(Image *image,const size_t length,
     }
     case BlobStream:
     {
-      if ((blob_info->offset+(MagickOffsetType) length) >=
-          (MagickOffsetType) blob_info->extent)
+      MagickSizeType
+        extent;
+
+      extent=(MagickSizeType) (blob_info->offset+(MagickOffsetType) length);
+      if (extent >= blob_info->extent)
         {
           if (blob_info->mapped != MagickFalse)
             return(0);
-          blob_info->extent+=length+blob_info->quantum;
+          blob_info->extent=extent+blob_info->quantum+length;
           blob_info->quantum<<=1;
           blob_info->data=(unsigned char *) ResizeQuantumMemory(
             blob_info->data,blob_info->extent+1,sizeof(*blob_info->data));
-- 
2.34.1

