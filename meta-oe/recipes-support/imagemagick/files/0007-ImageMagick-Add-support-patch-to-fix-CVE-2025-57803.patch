From 558a3a71c2b107483d8e88cd2d20242358b6633d Mon Sep 17 00:00:00 2001
From: Divyanshu Rathore <Divyanshu.Rathore@bmwtechworks.in>
Date: Fri, 5 Dec 2025 13:43:17 +0530
Subject: [PATCH 1/1] ImageMagick: Add support patch to fix CVE-2025-57803

Upstream-Status: Backport [https://github.com/ImageMagick/ImageMagick/commit/61f444e5457e4e506c73f18460133c80c235ebb6]

Comment: Refreshed hunk to match latest kirkstone

Signed-off-by: Divyanshu Rathore <Divyanshu.Rathore@bmwtechworks.in>
---
 coders/bmp.c | 17 ++++++-----------
 1 file changed, 6 insertions(+), 11 deletions(-)

diff --git a/coders/bmp.c b/coders/bmp.c
index a46448a95..703ad0483 100644
--- a/coders/bmp.c
+++ b/coders/bmp.c
@@ -968,18 +968,18 @@ static Image *ReadBMPImage(const ImageInfo *image_info,ExceptionInfo *exception)
       ThrowReaderException(CorruptImageError,"ImproperImageHeader");
     if (bmp_info.compression == BI_RLE4)
       bmp_info.bits_per_pixel<<=1;
-    bytes_per_line=4*((image->columns*bmp_info.bits_per_pixel+31)/32);
+    bytes_per_line=image->columns*(4*(bmp_info.bits_per_pixel+31)/32);
     length=(size_t) bytes_per_line*image->rows;
     if ((MagickSizeType) (length/256) > blob_size)
       ThrowReaderException(CorruptImageError,"InsufficientImageDataInFile");
+    pixel_info=AcquireVirtualMemory(image->rows,
+      MagickMax(bytes_per_line,image->columns+256UL)*sizeof(*pixels));
+    if (pixel_info == (MemoryInfo *) NULL)
+      ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
+    pixels=(unsigned char *) GetVirtualMemoryBlob(pixel_info);
     if ((bmp_info.compression == BI_RGB) ||
         (bmp_info.compression == BI_BITFIELDS))
       {
-        pixel_info=AcquireVirtualMemory(image->rows,
-          MagickMax(bytes_per_line,image->columns+256UL)*sizeof(*pixels));
-        if (pixel_info == (MemoryInfo *) NULL)
-          ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
-        pixels=(unsigned char *) GetVirtualMemoryBlob(pixel_info);
         if (image->debug != MagickFalse)
           (void) LogMagickEvent(CoderEvent,GetMagickModule(),
             "  Reading pixels (%.20g bytes)",(double) length);
@@ -996,11 +996,6 @@ static Image *ReadBMPImage(const ImageInfo *image_info,ExceptionInfo *exception)
         /*
           Convert run-length encoded raster pixels.
         */
-        pixel_info=AcquireVirtualMemory(image->rows,
-          MagickMax(bytes_per_line,image->columns+256UL)*sizeof(*pixels));
-        if (pixel_info == (MemoryInfo *) NULL)
-          ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
-        pixels=(unsigned char *) GetVirtualMemoryBlob(pixel_info);
         status=DecodeImage(image,bmp_info.compression,pixels,
           image->columns*image->rows);
         if (status == MagickFalse)
-- 
2.34.1

