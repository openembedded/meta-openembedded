From 12e9e846c20e8429940c1aab01ca8ffb9067bed0 Mon Sep 17 00:00:00 2001
From: Dirk Lemstra <dirk@lemstra.org>
Date: Sun, 12 Oct 2025 20:43:14 +0200
Subject: [PATCH] Added extra check to resolve issue on 32-bit systems
 (https://github.com/ImageMagick/ImageMagick/security/advisories/GHSA-9pp9-cfwx-54rm)

CVE: CVE-2025-62171
Upstream-Status: Backport [https://github.com/ImageMagick/ImageMagick/commit/cea1693e2ded51b4cc91c70c54096cbed1691c00]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 coders/bmp.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/coders/bmp.c b/coders/bmp.c
index 37f54e7f8..26deb34fe 100644
--- a/coders/bmp.c
+++ b/coders/bmp.c
@@ -976,6 +976,8 @@ static Image *ReadBMPImage(const ImageInfo *image_info,ExceptionInfo *exception)
       ThrowReaderException(CorruptImageError,"ImproperImageHeader");
     if (bmp_info.compression == BI_RLE4)
       bmp_info.bits_per_pixel<<=1;
+    if (BMPOverflowCheck(image->columns,bmp_info.bits_per_pixel) != MagickFalse)
+      ThrowReaderException(ResourceLimitError,"MemoryAllocationFailed");
     extent=image->columns*bmp_info.bits_per_pixel;
     bytes_per_line=4*((extent+31)/32);
     if (BMPOverflowCheck(bytes_per_line,image->rows) != MagickFalse)
