From 430c29617ce287db24872cb4e7fbb1e03d117d0a Mon Sep 17 00:00:00 2001
From: Cristy <urban-warrior@imagemagick.org>
Date: Thu, 7 Aug 2025 22:05:10 -0400
Subject: [PATCH] 
 https://github.com/ImageMagick/ImageMagick/security/advisories/GHSA-v393-38qx-v8fp

CVE: CVE-2025-55005
Upstream-Status: Backport [https://github.com/ImageMagick/ImageMagick/commit/b68bb6d3cfe472d5bd9329b4172e2e4f63d90a57]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 MagickCore/colorspace.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/MagickCore/colorspace.c b/MagickCore/colorspace.c
index a87defad8..82400ce46 100644
--- a/MagickCore/colorspace.c
+++ b/MagickCore/colorspace.c
@@ -2420,10 +2420,16 @@ static MagickBooleanType TransformsRGBImage(Image *image,
       value=GetImageProperty(image,"reference-black",exception);
       if (value != (const char *) NULL)
         reference_black=StringToDouble(value,(char **) NULL);
+      if (reference_black > 1024.0)
+        reference_black=1024.0;
       reference_white=ReferenceWhite;
       value=GetImageProperty(image,"reference-white",exception);
       if (value != (const char *) NULL)
         reference_white=StringToDouble(value,(char **) NULL);
+      if (reference_white > 1024.0)
+        reference_white=1024.0;
+      if (reference_black > reference_white)
+        reference_black=reference_white;
       logmap=(Quantum *) AcquireQuantumMemory((size_t) MaxMap+1UL,
         sizeof(*logmap));
       if (logmap == (Quantum *) NULL)
