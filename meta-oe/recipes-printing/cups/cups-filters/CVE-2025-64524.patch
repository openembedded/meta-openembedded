From 3f24ec5518f3f7f9a7020cd88bb9bbf4e81475fe Mon Sep 17 00:00:00 2001
From: Zdenek Dohnal <zdohnal@redhat.com>
Date: Wed, 12 Nov 2025 15:47:24 +0100
Subject: [PATCH] rastertopclx.c: Fix infinite loop caused by crafted file

Infinite loop happened because of crafted input raster file, which led
into heap buffer overflow of `CompressBuf` array.

Based on comments there should be always some `count` when compressing
the data, and processing of crafted file ended with offset and count
being 0.

Fixes CVE-2025-64524

CVE: CVE-2025-64524
Upstream-Status: Backport [https://github.com/OpenPrinting/cups-filters/commit/956283c74a34ae924266a2a63f8e5f529a1abd06]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 filter/rastertopclx.c | 26 ++++++++++++++++++++++++--
 1 file changed, 24 insertions(+), 2 deletions(-)

diff --git a/filter/rastertopclx.c b/filter/rastertopclx.c
index 3e7c129..b20d195 100644
--- a/filter/rastertopclx.c
+++ b/filter/rastertopclx.c
@@ -818,10 +818,10 @@ StartPage(ppd_file_t         *ppd,	/* I - PPD file */
   }
 
   if (header->cupsCompression)
-    CompBuffer = malloc(DotBufferSize * 4);
+    CompBuffer = calloc(DotBufferSize * 4, sizeof(unsigned char));
 
   if (header->cupsCompression >= 3)
-    SeedBuffer = malloc(DotBufferSize);
+    SeedBuffer = calloc(DotBufferSize, sizeof(unsigned char));
 
   SeedInvalid = 1;
 
@@ -1152,6 +1152,14 @@ CompressData(unsigned char *line,	/* I - Data to compress */
               seed ++;
               count ++;
             }
+
+           //
+           // Bail out if we don't have count to compress
+           //
+
+           if (count == 0)
+             break;
+
 	  }
 
          /*
@@ -1245,6 +1253,13 @@ CompressData(unsigned char *line,	/* I - Data to compress */
 
             count = line_ptr - start;
 
+           //
+           // Bail out if we don't have count to compress
+           //
+
+           if (count == 0)
+             break;
+
 #if 0
             fprintf(stderr, "DEBUG: offset=%d, count=%d, comp_ptr=%p(%d of %d)...\n",
 	            offset, count, comp_ptr, comp_ptr - CompBuffer,
@@ -1416,6 +1431,13 @@ CompressData(unsigned char *line,	/* I - Data to compress */
 
             count = (line_ptr - start) / 3;
 
+           //
+           // Bail out if we don't have count to compress
+           //
+
+           if (count == 0)
+             break;
+
            /*
             * Place mode 10 compression data in the buffer; each sequence
 	    * starts with a command byte that looks like:
