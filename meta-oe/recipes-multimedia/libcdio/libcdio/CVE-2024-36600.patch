From b620a2d3d37d8068bc69941155ba85e6c740d470 Mon Sep 17 00:00:00 2001
From: Yuxin Wang <yuxinwang9999@gmail.com>
Date: Sun, 13 Jul 2025 13:53:17 +0800
Subject: [PATCH] Fix buffer overrun for Joliet filenames

Joliet uses UCS-2 (2 bytes per character), and converting to UTF-8
may require up to 3 bytes per character. This patch increases the
buffer size by i_fname/2 to prevent buffer overrun.

CVE: CVE-2024-36600
Upstream-Status: Backport [https://github.com/libcdio/libcdio/commit/417478a7474af41c27ab3f876f31783fa06a5dbc]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 lib/iso9660/iso9660_fs.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lib/iso9660/iso9660_fs.c b/lib/iso9660/iso9660_fs.c
index 3b2f07c..9df1b94 100644
--- a/lib/iso9660/iso9660_fs.c
+++ b/lib/iso9660/iso9660_fs.c
@@ -859,6 +859,11 @@ _iso9660_dir_to_statbuf (iso9660_dir_t *p_iso9660_dir,
 
   /* .. string in statbuf is one longer than in p_iso9660_dir's listing '\1' */
   stat_len = sizeof(iso9660_stat_t) + i_fname + 2;
+#ifdef HAVE_JOLIET
+  if (u_joliet_level) {
+    stat_len += i_fname / 2;
+  }
+#endif
 
   /* Reuse multiextent p_stat if not NULL */
   if (!p_stat) {
