From 98fac0b396e1e85a6345baa59fc178b1f51759b8 Mon Sep 17 00:00:00 2001
From: Patrick Vogelaar <patrick.vogelaar@belden.com>
Date: Wed, 29 Oct 2025 13:33:23 +0100
Subject: [PATCH] Fix CVE-2025-11411 (possible domain hijacking attack)

This fixes CVE-2025-11411 by applying the minimal patch [1] listed in [2]

[1] https://nlnetlabs.nl/downloads/unbound/patch_CVE-2025-11411.diff
[2] https://www.nlnetlabs.nl/downloads/unbound/CVE-2025-11411.txt

CVE: CVE-2025-11411
Upstream-Status: Backport [minimal backport of https://github.com/NLnetLabs/unbound/commit/a33f0638e1dacf2633cf2292078a674576bca852]

Signed-off-by: Patrick Vogelaar <patrick.vogelaar@belden.com>
---
 iterator/iter_scrub.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/iterator/iter_scrub.c b/iterator/iter_scrub.c
index 48867e50..5beaa048 100644
--- a/iterator/iter_scrub.c
+++ b/iterator/iter_scrub.c
@@ -571,6 +571,22 @@ scrub_normalize(sldns_buffer* pkt, struct msg_parse* msg,
 					"RRset:", pkt, msg, prev, &rrset);
 				continue;
 			}
+			/* If the NS set is a promiscuous NS set, scrub that
+			 * to remove potential for poisonous contents that
+			 * affects other names in the same zone. Remove
+			 * promiscuous NS sets in positive answers, that
+			 * thus have records in the answer section. Nodata
+			 * and nxdomain promiscuous NS sets have been removed
+			 * already. Since the NS rrset is scrubbed, its
+			 * address records are also not marked to be allowed
+			 * and are removed later. */
+			if(FLAGS_GET_RCODE(msg->flags) == LDNS_RCODE_NOERROR &&
+				msg->an_rrsets != 0 &&
+				1 /* env->cfg->iter_scrub_promiscuous */) {
+				remove_rrset("normalize: removing promiscuous "
+					"RRset:", pkt, msg, prev, &rrset);
+				continue;
+			}
 			if(nsset == NULL) {
 				nsset = rrset;
 			} else {
-- 
2.34.1

