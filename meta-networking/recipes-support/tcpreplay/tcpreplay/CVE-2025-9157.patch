From 73008f261f1cdf7a1087dc8759115242696d35da Mon Sep 17 00:00:00 2001
From: Fred Klassen <fred.klassen@broadcom.com>
Date: Mon, 18 Aug 2025 18:35:16 -0700
Subject: [PATCH] Bug #970 tcprewrite: --fixlen: do not use realloc

No need to realloc if buffer is already proven to be big enough.

CVE: CVE-2025-9157

Upstream-Status: Backport [https://github.com/appneta/tcpreplay/commit/73008f261f1cdf7a1087dc8759115242696d35da]

Signed-off-by: Archana Polampalli <archana.polampalli@windriver.com>
---
 src/tcpedit/edit_packet.c | 1 -
 src/tcprewrite.c          | 2 ++
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/tcpedit/edit_packet.c b/src/tcpedit/edit_packet.c
index 1025ff9..f9ade8f 100644
--- a/src/tcpedit/edit_packet.c
+++ b/src/tcpedit/edit_packet.c
@@ -558,7 +558,6 @@ untrunc_packet(tcpedit_t *tcpedit,
          * which seems like a corrupted pcap
          */
         if (pkthdr->len > pkthdr->caplen) {
-            packet = safe_realloc(packet, pkthdr->len + PACKET_HEADROOM);
             memset(packet + pkthdr->caplen, '\0', pkthdr->len - pkthdr->caplen);
             pkthdr->caplen = pkthdr->len;
         } else if (pkthdr->len < pkthdr->caplen) {
diff --git a/src/tcprewrite.c b/src/tcprewrite.c
index c9aa52c..ee05a26 100644
--- a/src/tcprewrite.c
+++ b/src/tcprewrite.c
@@ -270,6 +270,8 @@ rewrite_packets(tcpedit_t *tcpedit_ctx, pcap_t *pin, pcap_dumper_t *pout)

         if (pkthdr.caplen > MAX_SNAPLEN)
             errx(-1, "Frame too big, caplen %d exceeds %d", pkthdr.caplen, MAX_SNAPLEN);
+        if (pkthdr.len > MAX_SNAPLEN)
+            errx(-1, "Frame too big, len %d exceeds %d", pkthdr.len, MAX_SNAPLEN);
         /*
          * copy over the packet so we can pad it out if necessary and
          * because pcap_next() returns a const ptr
--
2.40.0
