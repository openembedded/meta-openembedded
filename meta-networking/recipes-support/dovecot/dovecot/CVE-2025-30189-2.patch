From ca932f18061b643c19bae839ba3990bb16e51837 Mon Sep 17 00:00:00 2001
From: Aki Tuomi <aki.tuomi@open-xchange.com>
Date: Wed, 30 Jul 2025 09:42:20 +0300
Subject: [PATCH] auth: auth-cache - Refactor auth_cache_parse_key_and_fields()

Call auth_cache_parse_key_exclude() at the function end,
simplifies next commit.

CVE: CVE-2025-30189
Upstream-Status: Backport [https://github.com/dovecot/core/commit/c45ce2c073c9439a9d6366016cb4d41059d737f0]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/auth/auth-cache.c | 24 +++++++++++-------------
 1 file changed, 11 insertions(+), 13 deletions(-)

diff --git a/src/auth/auth-cache.c b/src/auth/auth-cache.c
index 360ad8b..3ccd45f 100644
--- a/src/auth/auth-cache.c
+++ b/src/auth/auth-cache.c
@@ -129,20 +129,18 @@ char *auth_cache_parse_key_and_fields(pool_t pool, const char *query,
 				      const ARRAY_TYPE(const_string) *fields,
 				      const char *exclude_driver)
 {
-	if (array_is_empty(fields))
-		return auth_cache_parse_key_exclude(pool, query, exclude_driver);
-
-	string_t *full_query = t_str_new(128);
-	str_append(full_query, query);
-
-	unsigned int i, count;
-	const char *const *str = array_get(fields, &count);
-	for (i = 0; i < count; i += 2) {
-		str_append_c(full_query, '\t');
-		str_append(full_query, str[i + 1]);
+	if (!array_is_empty(fields)) {
+		unsigned int i, count;
+		const char *const *str = array_get(fields, &count);
+		string_t *full_query = t_str_new(128);
+		str_append(full_query, query);
+		for (i = 0; i < count; i += 2) {
+			str_append_c(full_query, '\t');
+			str_append(full_query, str[i + 1]);
+		}
+		query = str_c(full_query);
 	}
-	return auth_cache_parse_key_exclude(pool, str_c(full_query),
-					    exclude_driver);
+	return auth_cache_parse_key_exclude(pool, query, exclude_driver);
 }
 
 static void
