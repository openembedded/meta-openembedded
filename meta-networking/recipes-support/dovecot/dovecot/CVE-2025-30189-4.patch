From e0a7cb4b1e0ccdc95a717567818d924ce2888ca3 Mon Sep 17 00:00:00 2001
From: Aki Tuomi <aki.tuomi@open-xchange.com>
Date: Fri, 25 Jul 2025 11:51:16 +0300
Subject: [PATCH] auth: auth-cache - Change auth_cache_parse_key_exclude() to
 return error

Simplifies following commit

CVE: CVE-2025-30189
Upstream-Status: Backport [https://github.com/dovecot/core/commit/d12bb78b5a235f31c9d5a655bd223c28d44bcadb]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/auth/auth-cache.c | 25 ++++++++++++++++++-------
 1 file changed, 18 insertions(+), 7 deletions(-)

diff --git a/src/auth/auth-cache.c b/src/auth/auth-cache.c
index ad8cbe5..407e5d4 100644
--- a/src/auth/auth-cache.c
+++ b/src/auth/auth-cache.c
@@ -64,8 +64,10 @@ static void auth_cache_key_add_tab_idx(string_t *str, unsigned int i)
 	str_append_c(str, '}');
 }
 
-static char *auth_cache_parse_key_exclude(pool_t pool, const char *query,
-					  const char *exclude_driver)
+static int auth_cache_parse_key_exclude(pool_t pool, const char *query,
+					const char *exclude_driver,
+					char **cache_key_r,
+					const char **error_r)
 {
 	string_t *str;
 	bool key_seen[AUTH_REQUEST_VAR_TAB_COUNT];
@@ -76,9 +78,9 @@ static char *auth_cache_parse_key_exclude(pool_t pool, const char *query,
 
 	struct var_expand_program *prog;
 	if (var_expand_program_create(query, &prog, &error) < 0) {
-		e_debug(auth_event, "auth-cache: var_expand_program_create('%s') failed: %s",
-			query, error);
-		return p_strdup(pool, "");
+		*error_r = t_strdup_printf("var_expand_program_create(%s) failed: %s",
+					   query, error);
+		return -1;
 	}
 
 	const char *const *vars = var_expand_program_variables(prog);
@@ -117,7 +119,8 @@ static char *auth_cache_parse_key_exclude(pool_t pool, const char *query,
 
 	var_expand_program_free(&prog);
 
-	return p_strdup(pool, str_c(str));
+	*cache_key_r = p_strdup(pool, str_c(str));
+	return 0;
 }
 
 char *auth_cache_parse_key(pool_t pool, const char *query)
@@ -140,7 +143,15 @@ char *auth_cache_parse_key_and_fields(pool_t pool, const char *query,
 		}
 		query = str_c(full_query);
 	}
-	return auth_cache_parse_key_exclude(pool, query, exclude_driver);
+
+	char *cache_key;
+	const char *error;
+	if (auth_cache_parse_key_exclude(pool, query, exclude_driver,
+					 &cache_key, &error) < 0) {
+		e_debug(auth_event, "auth-cache: %s", error);
+		cache_key = p_strdup(pool, "");
+	}
+	return cache_key;
 }
 
 static void
