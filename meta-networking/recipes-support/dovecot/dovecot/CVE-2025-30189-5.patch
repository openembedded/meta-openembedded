From b2d817db6c2a7229c9e3c4ccf8565acdd6f9a4c0 Mon Sep 17 00:00:00 2001
From: Aki Tuomi <aki.tuomi@open-xchange.com>
Date: Fri, 25 Jul 2025 11:52:36 +0300
Subject: [PATCH] auth: auth-cache - Treat cache key parsing errors as fatals

Avoids accidentically turning off caching

CVE: CVE-2025-30189
Upstream-Status: Backport [https://github.com/dovecot/core/commit/20d15baa071747f91176eb3115235aa8c78a3d11]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/auth/auth-cache.c | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/src/auth/auth-cache.c b/src/auth/auth-cache.c
index 407e5d4..be56934 100644
--- a/src/auth/auth-cache.c
+++ b/src/auth/auth-cache.c
@@ -147,10 +147,8 @@ char *auth_cache_parse_key_and_fields(pool_t pool, const char *query,
 	char *cache_key;
 	const char *error;
 	if (auth_cache_parse_key_exclude(pool, query, exclude_driver,
-					 &cache_key, &error) < 0) {
-		e_debug(auth_event, "auth-cache: %s", error);
-		cache_key = p_strdup(pool, "");
-	}
+					 &cache_key, &error) < 0)
+		i_fatal("auth-cache: %s", error);
 	return cache_key;
 }
 
