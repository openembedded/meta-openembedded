From 74c526047ffcecc40485df784294b27cedf66136 Mon Sep 17 00:00:00 2001
From: Aki Tuomi <aki.tuomi@open-xchange.com>
Date: Fri, 25 Jul 2025 11:48:43 +0300
Subject: [PATCH] auth: auth-cache - Deduplicate auth_cache_parse_key() to use
 auth_cache_parse_key_and_fields()

Simplifies following commit

CVE: CVE-2025-30189
Upstream-Status: Backport [https://github.com/dovecot/core/commit/759ee1af848480987d012de2f7135160156724b6]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 src/auth/auth-cache.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/auth/auth-cache.c b/src/auth/auth-cache.c
index 3ccd45f..ad8cbe5 100644
--- a/src/auth/auth-cache.c
+++ b/src/auth/auth-cache.c
@@ -122,14 +122,14 @@ static char *auth_cache_parse_key_exclude(pool_t pool, const char *query,
 
 char *auth_cache_parse_key(pool_t pool, const char *query)
 {
-	return auth_cache_parse_key_exclude(pool, query, NULL);
+	return auth_cache_parse_key_and_fields(pool, query, NULL, NULL);
 }
 
 char *auth_cache_parse_key_and_fields(pool_t pool, const char *query,
 				      const ARRAY_TYPE(const_string) *fields,
 				      const char *exclude_driver)
 {
-	if (!array_is_empty(fields)) {
+	if (fields != NULL && !array_is_empty(fields)) {
 		unsigned int i, count;
 		const char *const *str = array_get(fields, &count);
 		string_t *full_query = t_str_new(128);
