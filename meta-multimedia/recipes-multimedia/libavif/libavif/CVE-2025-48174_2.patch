From 5bd6529e7e729718ac2d164859965771466c8410 Mon Sep 17 00:00:00 2001
From: DanisJiang <43723722+DanisJiang@users.noreply.github.com>
Date: Mon, 21 Apr 2025 10:45:59 +0800
Subject: [PATCH] Add integer overflow check to makeRoom.

CVE: CVE-2025-48174
Upstream-Status: Backport [https://github.com/AOMediaCodec/libavif/commit/50a743062938a3828581d725facc9c2b92a1d109]
(cherry picked from commit 50a743062938a3828581d725facc9c2b92a1d109)
Signed-off-by: Ankur Tyagi <ankur.tyagi85@gmail.com>
---
 src/stream.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/stream.c b/src/stream.c
index 70e8bfaa..893ba3f0 100644
--- a/src/stream.c
+++ b/src/stream.c
@@ -319,10 +319,10 @@ avifBool avifROStreamReadAndEnforceVersion(avifROStream * stream, uint8_t enforc
 #define AVIF_STREAM_BUFFER_INCREMENT (1024 * 1024)
 static avifResult makeRoom(avifRWStream * stream, size_t size)
 {
-    size_t neededSize = stream->offset + size;
-    if (neededSize < stream->offset) {
-        return AVIF_RESULT_INVALID_ARGUMENT;
+    if (size > SIZE_MAX - stream->offset) {
+        return  AVIF_RESULT_OUT_OF_MEMORY;
     }
+    size_t neededSize = stream->offset + size;
     size_t newSize = stream->raw->size;
     while (newSize < neededSize) {
         newSize += AVIF_STREAM_BUFFER_INCREMENT;
